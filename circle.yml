machine:
  environment:
    CACHE_DIR: ~/quantum/dev-resources/cache
    OPENCL_SDK: $CACHE_DIR/opencl-sdk/intel_sdk_for_opencl_2016_ubuntu_6.0.0.1049_x64
    OPENCL_CODE_BUILDER: $CACHE_DIR/opencl-code-builder/intel_sdk_for_ocl_applications_2014_ubuntu_5.0.0.43_x64
    BASE_PKG: $OPENCL_CODE_BUILDER/rpm/opencl-1.2-base_5.0.0.43-2_amd64.deb
    INTEL_PKG: $OPENCL_CODE_BUILDER/rpm/opencl-1.2-intel-cpu_5.0.0.43-2_amd64.deb

dependencies:
  cache_directories:
    - ./dev-resources/cache/opencl-sdk
    - ./dev-resources/cache/opencl-code-builder
  pre:
    - if [[ ! -e $OPENCL_SDK ]]; then          (mkdir -p $CACHE_DIR/opencl-sdk          || true) && cd $CACHE_DIR/opencl-sdk          && wget -c http://registrationcenter-download.intel.com/akdlm/irc_nas/8555/intel_sdk_for_opencl_2016_ubuntu_6.0.0.1049_x64.tgz && tar -xzf intel_sdk_for_opencl_2016_ubuntu_6.0.0.1049_x64.tgz        && rm intel_sdk_for_opencl_2016_ubuntu_6.0.0.1049_x64.tgz       ; fi
    - if [[ ! -e $OPENCL_CODE_BUILDER ]]; then (mkdir -p $CACHE_DIR/opencl-code-builder || true) && cd $CACHE_DIR/opencl-code-builder && wget -c http://registrationcenter.intel.com/irc_nas/5193/intel_code_builder_for_opencl_2015_ubuntu_5.0.0.43_x64.tgz         && tar -xzf intel_code_builder_for_opencl_2015_ubuntu_5.0.0.43_x64.tgz && rm intel_code_builder_for_opencl_2015_ubuntu_5.0.0.43_x64.tgz; fi
    - sudo apt-get update
    - sudo apt-get install rpm alien libnuma1 clinfo -y
    - cd $OPENCL_CODE_BUILDER && sudo rpm --import PUBLIC_KEY.PUB
    - if [[ ! -e $BASE_PKG ]]; then  cd $OPENCL_CODE_BUILDER/rpm && fakeroot alien --to-deb opencl-1.2-base-5.0.0.43-1.x86_64.rpm     ; fi
    - if [[ ! -e $INTEL_PKG ]]; then cd $OPENCL_CODE_BUILDER/rpm && fakeroot alien --to-deb opencl-1.2-intel-cpu-5.0.0.43-1.x86_64.rpm; fi
    - sudo dpkg -i $BASE_PKG
    - sudo dpkg -i $INTEL_PKG
    - sudo touch /etc/ld.so.conf.d/intelOpenCL.conf
    - cd $OPENCL_SDK && (printf 'ACCEPT_EULA=accept\nINSTALL_MODE=NONRPM\nCONTINUE_WITH_OPTIONAL_ERROR=yes\nPSET_INSTALL_DIR=/opt\nCONTINUE_WITH_INSTALLDIR_OVERWRITE=yes\nCOMPONENTS=DEFAULTS\nPSET_MODE=install\nPHONEHOME_SEND_USAGE_DATA=no\nSIGNING_ENABLED=yes') > silent-final.config && sudo ./install.sh --silent silent-final.config
    - sudo ln /opt/intel/opencl-1.2-5.0.0.43/etc/intel64.icd /etc/OpenCL/vendors/intel64.icd
    - sudo printf '\nexport LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/opt/intel/opencl-1.2-5.0.0.43/lib64 && export PATH=$PATH:/opt/intel/intel-opencl-1.2-6.0.0.1049/opencl-sdk/include\n' >> ~/.bashrc
    - sudo clinfo | grep Intel
test:
  override:
    - case $CIRCLE_NODE_INDEX in 0) echo "lein test:clj" && lein test:clj ;; 1) echo "lein test:cljs" && lein test:cljs ;; esac:
        parallel: true
